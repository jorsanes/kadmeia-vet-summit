<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>KADMEIA CMS</title>
  </head>
  <body>
    <!-- Error Banner -->
    <div id="error-banner" style="display:none; position:fixed; top:0; left:0; right:0; background:#dc2626; color:white; padding:12px; text-align:center; z-index:9999; font-family:monospace;">
      <div id="error-message"></div>
      <button onclick="clearSessionAndRetry()" style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3); color:white; padding:4px 8px; margin-left:8px; cursor:pointer; border-radius:4px;">
        Cerrar sesi√≥n y reintentar
      </button>
    </div>

    <!-- Loading Banner -->
    <div id="loading-banner" style="position:fixed; top:0; left:0; right:0; background:#1E2A38; color:white; padding:12px; text-align:center; z-index:9998; font-family:monospace;">
      Verificando acceso al repositorio...
    </div>

    <!-- 1) Bridge: escucha el postMessage del provider y persiste el token -->
    <script src="./oauth-bridge.js"></script>

    <!-- 2) Manual Init (cargamos config desde JS, no YAML) -->
    <script>window.CMS_MANUAL_INIT = true;</script>

    <!-- 3) Autotest antes de cargar Decap -->
    <script>
      // Funci√≥n para limpiar sesi√≥n y reintentar
      function clearSessionAndRetry() {
        console.log('üßπ Limpiando sesi√≥n...');
        const keys = Object.keys(localStorage).filter(k => 
          k.includes('netlify-cms') || k.includes('decap-cms')
        );
        keys.forEach(k => localStorage.removeItem(k));
        location.reload();
      }

      // Funci√≥n para mostrar error
      function showError(message) {
        document.getElementById('loading-banner').style.display = 'none';
        document.getElementById('error-banner').style.display = 'block';
        document.getElementById('error-message').textContent = message;
      }

      // Funci√≥n para ocultar banners
      function hideBanners() {
        document.getElementById('loading-banner').style.display = 'none';
        document.getElementById('error-banner').style.display = 'none';
      }

      // Autotest de repositorio
      async function runRepositoryTest() {
        try {
          // Obtener token del localStorage
          const authData = localStorage.getItem('netlify-cms-auth') || 
                          localStorage.getItem('decap-cms-auth');
          
          if (!authData) {
            console.log('üìù No hay token de autenticaci√≥n, continuando con login...');
            hideBanners();
            return true; // Continuar con el flujo normal de login
          }

          const auth = JSON.parse(authData);
          const token = auth.token;

          if (!token) {
            showError('Token de autenticaci√≥n inv√°lido');
            return false;
          }

          console.log('üîë Token encontrado, verificando acceso...');

          // Test 1: Verificar token con GitHub API
          const userResponse = await fetch('https://api.github.com/user', {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Accept': 'application/vnd.github+json'
            }
          });

          if (!userResponse.ok) {
            showError(`Token inv√°lido o expirado (${userResponse.status})`);
            return false;
          }

          const userData = await userResponse.json();
          console.log('‚úÖ Token v√°lido para usuario:', userData.login);

          // Test 2: Verificar acceso al repositorio
          const repoSlug = 'jorsanes/kadmeia-vet-summit'; // Del config
          const repoResponse = await fetch(`https://api.github.com/repos/${repoSlug}`, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Accept': 'application/vnd.github+json'
            }
          });

          if (!repoResponse.ok) {
            if (repoResponse.status === 404) {
              showError(`Repositorio '${repoSlug}' no encontrado o sin permisos`);
            } else {
              showError(`Error accediendo al repositorio (${repoResponse.status})`);
            }
            return false;
          }

          const repoData = await repoResponse.json();
          console.log('‚úÖ Acceso al repositorio confirmado:', repoData.full_name);

          // Test 3: Verificar rama
          const branch = 'main';
          const branchResponse = await fetch(`https://api.github.com/repos/${repoSlug}/branches/${branch}`, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Accept': 'application/vnd.github+json'
            }
          });

          if (!branchResponse.ok) {
            showError(`Rama '${branch}' no encontrada en el repositorio`);
            return false;
          }

          console.log('‚úÖ Rama confirmada:', branch);
          hideBanners();
          return true;

        } catch (error) {
          console.error('‚ùå Error en autotest:', error);
          showError(`Error de conexi√≥n: ${error.message}`);
          return false;
        }
      }

      // Ejecutar autotest y cargar CMS solo si pasa
      runRepositoryTest().then(success => {
        if (success) {
          console.log('‚úÖ Todos los tests pasaron, cargando Decap CMS...');
          hideBanners();
          
          // Cargar Decap CMS con configuraci√≥n inline para evitar problemas con config.yml
          const script = document.createElement('script');
          script.src = 'https://unpkg.com/decap-cms@^3/dist/decap-cms.js';
          script.onload = () => {
            console.log('üì¶ Decap CMS cargado, configurando...');
            
            // Configurar Decap directamente sin archivo externo
            if (window.CMS && window.CMS.init) {
              window.CMS.init({
                config: {
                  backend: {
                    name: 'github',
                    repo: 'jorsanes/kadmeia-vet-summit',
                    branch: 'main'
                  },
                  site_url: 'https://www.kadmeia.com',
                  display_url: 'https://www.kadmeia.com',
                  media_folder: 'public/uploads',
                  public_folder: '/uploads',
                  publish_mode: 'editorial_workflow',
                  slug: {
                    encoding: 'ascii',
                    clean_accents: true,
                    sanitize_replacement: '-'
                  },
                  collections: [
                    {
                      name: 'blog_es',
                      label: 'Blog (Espa√±ol)',
                      folder: 'src/content/blog/es',
                      slug: '{{slug}}',
                      extension: 'mdx',
                      format: 'frontmatter',
                      create: true,
                      sortable_fields: ['title', 'date', 'draft'],
                      view_filters: [
                        { label: 'Borradores', field: 'draft', pattern: true },
                        { label: 'Publicados', field: 'draft', pattern: false }
                      ],
                      fields: [
                        { label: 'T√≠tulo', name: 'title', widget: 'string' },
                        { label: 'Fecha', name: 'date', widget: 'datetime', format: 'YYYY-MM-DD' },
                        { label: 'Resumen', name: 'excerpt', widget: 'string' },
                        { label: 'Imagen de portada', name: 'cover', widget: 'image', required: false },
                        { label: 'Idioma', name: 'lang', widget: 'hidden', default: 'es' },
                        { label: 'Etiquetas', name: 'tags', widget: 'list', default: [] },
                        { label: 'Borrador', name: 'draft', widget: 'boolean', default: false },
                        { label: 'Contenido', name: 'body', widget: 'markdown' }
                      ]
                    },
                    {
                      name: 'blog_en',
                      label: 'Blog (English)',
                      folder: 'src/content/blog/en',
                      slug: '{{slug}}',
                      extension: 'mdx',
                      format: 'frontmatter',
                      create: true,
                      sortable_fields: ['title', 'date', 'draft'],
                      view_filters: [
                        { label: 'Drafts', field: 'draft', pattern: true },
                        { label: 'Published', field: 'draft', pattern: false }
                      ],
                      fields: [
                        { label: 'Title', name: 'title', widget: 'string' },
                        { label: 'Date', name: 'date', widget: 'datetime', format: 'YYYY-MM-DD' },
                        { label: 'Excerpt', name: 'excerpt', widget: 'string' },
                        { label: 'Cover image', name: 'cover', widget: 'image', required: false },
                        { label: 'Language', name: 'lang', widget: 'hidden', default: 'en' },
                        { label: 'Tags', name: 'tags', widget: 'list', default: [] },
                        { label: 'Draft', name: 'draft', widget: 'boolean', default: false },
                        { label: 'Content', name: 'body', widget: 'markdown' }
                      ]
                    },
                    {
                      name: 'cases_es',
                      label: 'Casos (Espa√±ol)',
                      folder: 'src/content/casos/es',
                      slug: '{{slug}}',
                      extension: 'mdx',
                      format: 'frontmatter',
                      create: true,
                      sortable_fields: ['title', 'date', 'draft'],
                      view_filters: [
                        { label: 'Borradores', field: 'draft', pattern: true },
                        { label: 'Publicados', field: 'draft', pattern: false }
                      ],
                      fields: [
                        { label: 'T√≠tulo', name: 'title', widget: 'string' },
                        { label: 'Fecha', name: 'date', widget: 'datetime', format: 'YYYY-MM-DD' },
                        { label: 'Resumen', name: 'excerpt', widget: 'string' },
                        { label: 'Imagen de portada', name: 'cover', widget: 'image', required: false },
                        { label: 'Idioma', name: 'lang', widget: 'hidden', default: 'es' },
                        { label: 'Etiquetas', name: 'tags', widget: 'list', default: [] },
                        { label: 'Borrador', name: 'draft', widget: 'boolean', default: false },
                        { label: 'Contenido', name: 'body', widget: 'markdown' }
                      ]
                    },
                    {
                      name: 'cases_en',
                      label: 'Cases (English)',
                      folder: 'src/content/casos/en',
                      slug: '{{slug}}',
                      extension: 'mdx',
                      format: 'frontmatter',
                      create: true,
                      sortable_fields: ['title', 'date', 'draft'],
                      view_filters: [
                        { label: 'Drafts', field: 'draft', pattern: true },
                        { label: 'Published', field: 'draft', pattern: false }
                      ],
                      fields: [
                        { label: 'Title', name: 'title', widget: 'string' },
                        { label: 'Date', name: 'date', widget: 'datetime', format: 'YYYY-MM-DD' },
                        { label: 'Excerpt', name: 'excerpt', widget: 'string' },
                        { label: 'Cover image', name: 'cover', widget: 'image', required: false },
                        { label: 'Language', name: 'lang', widget: 'hidden', default: 'en' },
                        { label: 'Tags', name: 'tags', widget: 'list', default: [] },
                        { label: 'Draft', name: 'draft', widget: 'boolean', default: false },
                        { label: 'Content', name: 'body', widget: 'markdown' }
                      ]
                    }
                  ]
                }
              });
              console.log('üéØ Decap CMS inicializado con configuraci√≥n inline');
            } else {
              console.error('‚ùå window.CMS no disponible');
            }
          };
          document.head.appendChild(script);
        }
      });
    </script>
  </body>
</html>
